<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Analyse de la covariance</title>
    <meta charset="utf-8" />
    <meta name="author" content="Marie-Pierre Etienne" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/metropolis.css" rel="stylesheet" />
    <link rel="stylesheet" href="mpe_pres.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Analyse de la covariance
### Marie-Pierre Etienne
### <a href="mailto:marie-pierre.etienne@agrocampus-ouest.fr" class="email">marie-pierre.etienne@agrocampus-ouest.fr</a>
### 2021/11/19 (updated: 2023-01-12)

---




---
name: ancova
# Comparaison de droite de régression : modèle d'analyse de la covariance

--
## Cadre général
C'est la situation où 
* la variable à expliquer `\(Y\)` est quantitative
* Les variables explicatives sont qualitatives et quantitatives


```
## `geom_smooth()` using formula 'y ~ x'
```

```
## Warning: Removed 2 rows containing non-finite values (stat_smooth).
```

```
## Warning: Removed 2 rows containing missing values (geom_point).
```

![](ancova_files/figure-html/load_penguins-1.png)&lt;!-- --&gt;

---

template: ancova
## Le modèle

`$$M_{comp} : \class{alea}{Y_{ik}} = \class{rouge}{\mu} + \class{rouge}{\alpha_i} + \class{rouge}{\beta}x_{ik} +\class{rouge}{\gamma_i} x_{ik} + \class{alea}{E_{ik}},\quad \class{alea}{E_{ik}}\overset{ind}{\sim}\mathcal{N}(0, \class{rouge}{\sigma^2}),$$`
avec 
- `\(i=1,\ldots,I\)` le niveau du facteur 1,
- `\(x_{ik}\)` la mesure de la variable quantitative `\(x\)` sur l'individu `\(k\)` du groupe `\(i\)`, 
- `\(\class{rouge}{\mu}\)` l'ordonnée à l'origine de référence,
- `\(\class{rouge}{\alpha_i}\)` l'effet différentiel de l'espèce `\(i\)` sur l'ordonnée à l'origine, ( `\(\alpha_1=0\)` )
- `\(\class{rouge}{\beta}\)` l'effet de la variable `\(x\)` pour le groupe de référence,   
- `\(\class{rouge}{\gamma_i}\)` l'effet différentiel de la variable `\(x\)` pour le groupe `\(i\)` par rapport au groupe de référence ( `\(\gamma_1=0\)` ),  
- `\(\class{rouge}{\sigma^2}\)` la variance commune à tous les groupes.


### Nombre de paramètres du modèle

- `\(2I\)` paramètres de moyenne  `\((\class{rouge}{(\mu, \alpha_2, \ldots, \alpha_I, \beta, \gamma_2, \ldots, \gamma_I)}\)`; 
- 1 paramètre de variance `\(\class{rouge}{\sigma^2}\)`



---
name: test_complet

# Tests dans le modèle d'analyse de la covariance

--
## Test du modèle complet 

Pour répondre à la question "La longueur des ailes des manchots est elle liée à leur masse et/ou à leur espèce ?"



`$$\begin{align} 
H_0 &amp; =\left \lbrace \mbox{La longueur des ailes est la même en moyenne quelque soit la masse ou l'espèce du manchot }\right\rbrace\\
    &amp; =\left \lbrace  \mbox{pour tout }i, \alpha_i =0,  \gamma_i = 0 \mbox{ et }\beta=0   \right\rbrace\\
    &amp; =\left \lbrace  M_{comp} \mbox{ est équivalent à } M0 \right\rbrace.
\end{align}$$`

`\(H_1\)` prend les formes équivalentes suivantes

`$$\begin{align} 
H_1 &amp; =\left \lbrace \mbox{la longueur des ailes varie selon la masse ou l'espèce }\right\rbrace\\
    &amp; =\left \lbrace  \mbox{Il existe un }i, \alpha_i  \ne 0  \mbox{ ou un } \gamma_i \ne 0  \mbox{ ou } \beta \ne 0 \right\rbrace\\
    &amp; =\left \lbrace  M_{comp} \mbox{ est préférable à } M0 \right\rbrace.
\end{align}$$`
---
template: test_complet

## Test du modèle complet 

### Statistique de test 

$$ F = \frac{\frac{RSS_0-RSS}{2I-1}}{\frac{RSS}{n-2I}} \underset{H_0}{\sim} \mathcal{F}(2I-1, n-2I) $$
---
template: test_complet

## Test du modèle complet sur l'exemple manchot


```r
Mcomp &lt;- lm(flipper_length_mm ~ species + body_mass_g + species:body_mass_g, data =penguins)
M0 &lt;- lm(flipper_length_mm ~ 1, data =penguins)
anova(M0, Mcomp)
```

```
## Analysis of Variance Table
## 
## Model 1: flipper_length_mm ~ 1
## Model 2: flipper_length_mm ~ species + body_mass_g + species:body_mass_g
##   Res.Df   RSS Df Sum of Sq      F    Pr(&gt;F)    
## 1    341 67427                                  
## 2    336  9611  5     57815 404.24 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---
template: test_complet

## Test de l'égalité des pentes 
--

`$$\begin{align} 
H_0 &amp; =\left \lbrace \mbox{La longueur des ailes augmente de la même manière avec le poids quelque soit l'espèce }\right\rbrace\\
    &amp; =\left \lbrace  \mbox{pour tout }i, \gamma_i = 0   \right\rbrace\\
    &amp; =\left \lbrace  M_{comp} \mbox{ est équivalent à } M_{12} \right\rbrace.
\end{align}$$`

`$$M_{12} : \class{alea}{Y_{ik}} = \class{rouge}{\mu} + \class{rouge}{\alpha_i} + \class{rouge}{\beta}x_{ik} + \class{alea}{E_{ik}},\quad \class{alea}{E_{ik}}\overset{ind}{\sim}\mathcal{N}(0, \class{rouge}{\sigma^2})$$`
--

`$$\begin{align} 
H_1 &amp; =\left \lbrace \mbox{L'augmentation de longueur des ailes avec le poids n'est pas la même pour toutes les espèces}\right\rbrace\\
    &amp; =\left \lbrace  \mbox{Il existe un }i,\gamma_i \ne 0 \right\rbrace\\
    &amp; =\left \lbrace  M_{comp} \mbox{ est préférable à } M_{12} \right\rbrace.
\end{align}$$`


---
template: test_complet

## Test de l'égalité des pentes 

### Statistique de test 
--

`$$F = \frac{\frac{RSS_{12}-RSS}{I-1}}
{\frac{RSS}{n-2I}} \underset{H_0}{\sim} \mathcal{F}(I-1, n-2I)$$`

--
2 situations :
* si les pentes sont différentes, on a mis en évidence un effet de l'espèce et un effet de la masse ne serait ce qu'au travers de leur interaction.

* si les pentes sont identiques, le modèle `\(M_{12}\)` devient alors le modèle le plus complet considéré et on teste si la pente est différente de 0 et on teste si les ordonnées à l'origine sont identiques.

Quels modèles peut on comparer ?


---
template: test_complet

## Test de l'égalité des pentes sur l'exemple manchots



```r
M12 &lt;- lm(flipper_length_mm ~ species + body_mass_g, data =penguins)
anova(M12, Mcomp)
```

```
## Analysis of Variance Table
## 
## Model 1: flipper_length_mm ~ species + body_mass_g
## Model 2: flipper_length_mm ~ species + body_mass_g + species:body_mass_g
##   Res.Df    RSS Df Sum of Sq      F Pr(&gt;F)  
## 1    338 9839.1                             
## 2    336 9611.2  2    227.91 3.9837 0.0195 *
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```


---
template: test_complet


Que teste-t-on avec cette commande ?


```r
library(car)
```

```
## Warning: package 'car' was built under R version 4.0.5
```

```
## Loading required package: carData
```

```
## 
## Attaching package: 'car'
```

```
## The following object is masked from 'package:dplyr':
## 
##     recode
```

```
## The following object is masked from 'package:purrr':
## 
##     some
```

```r
Anova(Mcomp)
```

```
## Anova Table (Type II tests)
## 
## Response: flipper_length_mm
##                     Sum Sq  Df  F value Pr(&gt;F)    
## species             6411.2   2 112.0661 &lt;2e-16 ***
## body_mass_g         5114.2   1 178.7885 &lt;2e-16 ***
## species:body_mass_g  227.9   2   3.9837 0.0195 *  
## Residuals           9611.2 336                    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---
name: ajuste

# Comparer les espèces à poids équivalents

La répondre à la question "Les longueurs des ailes des manchots des différentes espèces sont-elles comparables"

Pour rendre la comparaison juste, il faut choisir un poids de référence. 

--

Moyenne ajustée 

`$$\hat{\mu}_i = \mu + \alpha_i + (\beta+\gamma_i) \bar{x}$$`

--

```r
library(emmeans)
```

```
## Warning: package 'emmeans' was built under R version 4.0.5
```

```
## 
## Attaching package: 'emmeans'
```

```
## The following object is masked from 'package:devtools':
## 
##     test
```

```r
mean_length &lt;- emmeans(object = Mcomp, specs = ~ species)
```

```
## NOTE: Results may be misleading due to involvement in interactions
```

```r
pairs(mean_length, adjust = "bonf")
```

```
##  contrast           estimate   SE  df t.ratio p.value
##  Adelie - Chinstrap    -8.10 1.21 336  -6.678  &lt;.0001
##  Adelie - Gentoo      -15.99 1.16 336 -13.733  &lt;.0001
##  Chinstrap - Gentoo    -7.88 1.41 336  -5.582  &lt;.0001
## 
## P value adjustment: bonferroni method for 3 tests
```

```r
plot(mean_length)
```

![](ancova_files/figure-html/ajuste-1.png)&lt;!-- --&gt;




    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="../courses_tools/resources/collapseoutput.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:10",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
